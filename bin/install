#!/usr/bin/env bash

# This script downloads and installs a specific version of mvnd.
# It's designed for the 'mise' version manager and handles .tar.gz archives.


# Determine the operating system and architecture to build the correct download URL.
get_platform_arch() {
    local os
    local arch

    case "$(uname -s)" in
        Linux*)     os=linux;;
        Darwin*)    os=darwin;;
        *)          echo "Unsupported OS: $(uname -s)" >&2; exit 1;;
    esac

    case "$(uname -m)" in
        x86_64)     arch=amd64;;
        aarch64)    arch=aarch64;;
        arm64)      arch=aarch64;; # For macOS ARM
        *)          echo "Unsupported architecture: $(uname -m)" >&2; exit 1;;
    esac

    echo "${os}-${arch}"
}

# The main function to download and install mvnd
main() {
    local version="${MISE_TOOL_VERSION}"
    local install_path="${MISE_INSTALL_PATH}"

    local platform_arch
    platform_arch=$(get_platform_arch)

    local download_file="maven-mvnd-${version}-${platform_arch}.tar.gz"
    local url="https://github.com/apache/maven-mvnd/releases/download/${version}/${download_file}"

    echo "Downloading mvnd ${version} for ${platform_arch} from ${url}"

    local tmp_dir
    tmp_dir=$(mktemp -d)
    
    curl --fail --location --progress-bar --retry 3 --retry-delay 3 \
        -o "${tmp_dir}/${download_file}" "${url}"

    tar -xzf "${tmp_dir}/${download_file}" -C "${install_path}"
    
    local extracted_dir="${install_path}/maven-mvnd-${version}-${platform_arch}"
    mv "${extracted_dir}"/* "${install_path}/"
    rmdir "${extracted_dir}"

    rm -rf "${tmp_dir}"
    
    echo "mvnd ${version} installed successfully in ${install_path}"
}

main